name: CI/CD Pipeline (Quality & Build)

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch: # Avvio manuale

jobs:
  # -----------------------------------------------------
  # 1. VERIFICA FORMATTAZIONE
  # -----------------------------------------------------
  formatting_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 'stable'

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'

      - name: Cache Dart Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            frontend/.dart_tool/package_config.json
            backend/.dart_tool/package_config.json
            data_models/.dart_tool/package_config.json
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      # Installazione dipendenze per formatting
      - name: Pub Get - Data Models
        run: dart pub get
        working-directory: data_models
      - name: Pub Get - Backend
        run: dart pub get
        working-directory: backend
      - name: Pub Get - Frontend
        run: flutter pub get
        working-directory: frontend

      - name: ðŸ” Check Formatting - Data Models
        run: dart format --output=none --set-exit-if-changed .
        working-directory: data_models
        continue-on-error: true # Non blocchiamo subito, mostriamo l'errore dopo

      - name: ðŸ” Check Formatting - Frontend
        run: dart format --output=none --set-exit-if-changed .
        working-directory: frontend

  # -----------------------------------------------------
  # 2. ANALISI STATICA (Bloccante)
  # -----------------------------------------------------
  static_analysis:
    runs-on: ubuntu-latest
    needs: formatting_check # Parte solo se formatting finisce

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'

      - name: Pub Get - Data Models
        run: dart pub get
        working-directory: data_models
      - name: Pub Get - Backend
        run: dart pub get
        working-directory: backend
      - name: Pub Get - Frontend
        run: flutter pub get
        working-directory: frontend

      - name: Analyze Data Models
        run: dart analyze .
        working-directory: data_models

      - name: Analyze Backend
        run: dart analyze .
        working-directory: backend

      - name: Analyze Frontend
        run: flutter analyze
        working-directory: frontend

  # -----------------------------------------------------
  # 3. BUILD APK (Non Bloccante)
  # -----------------------------------------------------
  build_apk:
    runs-on: ubuntu-latest
    needs: static_analysis # Parte solo se l'analisi Ã¨ OK
    # Se questo job fallisce, il workflow rimane VERDE
    continue-on-error: true

    # Esegui solo su push/manuale (evita di buildare APK su ogni commit di PR per risparmiare tempo)
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Importante: Setup Java per la build Android
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'

      # --- DEBUG SECRET (Sicuro) ---
      - name: Check Secret Availability
        env:
          KEYSTORE_BASE64: ${{ secrets.DEV_ANDROID_DEBUG_KEYSTORE }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "ERRORE CRITICO: Il secret DEV_ANDROID_DEBUG_KEYSTORE e vuoto o non esiste!"
            exit 1
          else
            echo "OK: Il secret e stato trovato (Lunghezza: ${#KEYSTORE_BASE64} caratteri)."
          fi
        shell: bash

      # --- DECODIFICA KEYSTORE ---
      - name: Decode Keystore
        shell: bash
        env:
          KEYSTORE_BASE64: ${{ secrets.DEV_ANDROID_DEBUG_KEYSTORE }}
        run: |
          echo "Decodifica debug.keystore dai Secret..."
          # Usiamo printf per evitare problemi con echo su stringhe lunghe
          printf "%s" "$KEYSTORE_BASE64" | base64 --decode > frontend/android/app/debug.keystore

      # --- DECODIFICA JSON ---
      - name: Decode Google Services
        shell: bash
        env:
          GOOGLE_JSON_BASE64: ${{ secrets.DEV_GOOGLE_SERVICES_JSON }}
        run: |
          echo "Decodifica google-services.json..."
          printf "%s" "$GOOGLE_JSON_BASE64" | base64 --decode > frontend/android/app/google-services.json

      # --- VERIFICA CONTENUTO ---
      - name: Verify Keystore Content
        run: |
          echo "Verifica dimensione file:"
          ls -lh frontend/android/app/debug.keystore
          
          echo "Verifica validita Keystore:"
          keytool -list -v \
            -keystore frontend/android/app/debug.keystore \
            -alias androiddebugkey \
            -storepass android
        working-directory: .

      - name: Pub Get - Data Models
        run: dart pub get
        working-directory: data_models

      - name: Pub Get - Frontend
        run: flutter pub get
        working-directory: frontend

      # --- GENERAZIONE ASSETS GRAFICI ---
      - name: Generate Native Splash
        working-directory: frontend
        run: dart run flutter_native_splash:create

      - name: Generate Launcher Icons
        working-directory: frontend
        run: dart run flutter_launcher_icons
      # ----------------------------------

      - name: Build Release APK
        working-directory: frontend
        run: |
          flutter build apk --release \
            --dart-define=SERVER_HOST=${{ secrets.DEV_SERVER_HOST }} \
            --dart-define=SERVER_PORT=${{ secrets.DEV_SERVER_PORT }} \
            --dart-define=API_PREFIX=${{ secrets.DEV_API_PREFIX }}

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-dev-release
          path: frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 5
