name: CI/CD Pipeline (Quality & Build)

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch: # Avvio manuale

jobs:
  # -----------------------------------------------------
  # 1. VERIFICA FORMATTAZIONE
  # -----------------------------------------------------
  formatting_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: 'stable'

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'

      - name: Cache Dart Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            frontend/.dart_tool/package_config.json
            backend/.dart_tool/package_config.json
            data_models/.dart_tool/package_config.json
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      # Installazione dipendenze per formatting
      - name: Pub Get - Data Models
        run: dart pub get
        working-directory: data_models
      - name: Pub Get - Backend
        run: dart pub get
        working-directory: backend
      - name: Pub Get - Frontend
        run: flutter pub get
        working-directory: frontend

      - name: ðŸ” Check Formatting - Data Models
        run: dart format --output=none --set-exit-if-changed .
        working-directory: data_models
        continue-on-error: true # Non blocchiamo subito, mostriamo l'errore dopo

      - name: ðŸ” Check Formatting - Frontend
        run: dart format --output=none --set-exit-if-changed .
        working-directory: frontend

  # -----------------------------------------------------
  # 2. ANALISI STATICA (Bloccante)
  # -----------------------------------------------------
  static_analysis:
    runs-on: ubuntu-latest
    needs: formatting_check # Parte solo se formatting finisce

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'

      - name: Pub Get - Data Models
        run: dart pub get
        working-directory: data_models
      - name: Pub Get - Backend
        run: dart pub get
        working-directory: backend
      - name: Pub Get - Frontend
        run: flutter pub get
        working-directory: frontend

      - name: Analyze Data Models
        run: dart analyze .
        working-directory: data_models

      - name: Analyze Backend
        run: dart analyze .
        working-directory: backend

      - name: Analyze Frontend
        run: flutter analyze
        working-directory: frontend

  # -----------------------------------------------------
  # 3. BUILD APK (Non Bloccante)
  # -----------------------------------------------------
  build_apk:
    runs-on: ubuntu-latest
    needs: static_analysis # Parte solo se l'analisi Ã¨ OK
    # Se questo job fallisce, il workflow rimane VERDE
    continue-on-error: true

    # Esegui solo su push/manuale (evita di buildare APK su ogni commit di PR per risparmiare tempo)
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Importante: Setup Java per la build Android
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.2'

      # Decodifica dei file sensibili con metodo robusto (file temporanei)
      - name: Decode Keystore and Google Services
        shell: bash
        env:
          KEYSTORE_BASE64: ${{ secrets.DEV_ANDROID_DEBUG_KEYSTORE }}
          GOOGLE_JSON_BASE64: ${{ secrets.DEV_GOOGLE_SERVICES_JSON }}
        run: |
          echo "Creazione directory temporanea per i segreti..."
          mkdir secrets-base64

          echo "Salvataggio variabili env in file temporanei..."
          echo "$KEYSTORE_BASE64" > secrets-base64/keystore.base64
          echo "$GOOGLE_JSON_BASE64" > secrets-base64/google-services.base64

          echo "Decodifica dei file verso le destinazioni finali..."
          base64 --decode secrets-base64/keystore.base64 > frontend/android/app/debug.keystore
          base64 --decode secrets-base64/google-services.base64 > frontend/android/app/google-services.json
          
          echo "Pulizia file temporanei..."
          rm -rf secrets-base64

      - name: Check existence of decoded files
        run: |
          ls -l frontend/android/app/debug.keystore
          ls -l frontend/android/app/google-services.json

      - name: Pub Get - Data Models
        run: dart pub get
        working-directory: data_models

      - name: Pub Get - Frontend
        run: flutter pub get
        working-directory: frontend

      # --- GENERAZIONE ASSETS GRAFICI ---
      - name: Generate Native Splash
        working-directory: frontend
        run: dart run flutter_native_splash:create

      - name: Generate Launcher Icons
        working-directory: frontend
        run: dart run flutter_launcher_icons
      # ----------------------------------

      - name: Build Release APK (Dev Config)
        working-directory: frontend
        run: |
          flutter build apk --release \
            --dart-define=SERVER_HOST=${{ secrets.DEV_SERVER_HOST }} \
            --dart-define=SERVER_PORT=${{ secrets.DEV_SERVER_PORT }} \
            --dart-define=API_PREFIX=${{ secrets.DEV_API_PREFIX }}

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-dev-release
          path: frontend/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 5
